package controller;

import javafx.application.Platform;
import javafx.collections.FXCollections;
import javafx.fxml.FXML;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.control.*;
import javafx.scene.layout.*;  
import javafx.scene.paint.Color;
import model.*;
import service.*;

import java.util.*;
import java.util.stream.Collectors;

import javax.swing.plaf.synth.Region;

public class MainController {
    
    @FXML private TextArea inputTextArea;
    @FXML private Button analyzeButton;
    @FXML private VBox resultBox;
    @FXML private Label emotionLabel;
    @FXML private Label intensityLabel;
    @FXML private TextArea responseTextArea;
    @FXML private VBox historyBox;
    @FXML private VBox statsBox;
    @FXML private TabPane tabPane;
    @FXML private ProgressIndicator loadingIndicator;
    @FXML private ComboBox<String> contactComboBox;
    @FXML private Button addContactButton;
    @FXML private Label contactCountLabel;
    
    private GeminiService geminiService;
    private DataManager dataManager;
    private ContactManager contactManager; // ğŸ†•
    
    @FXML
    public void initialize() {
        geminiService = new GeminiService();
        dataManager = new DataManager();
        contactManager = new ContactManager(); // ğŸ†•
        
        if (loadingIndicator != null) {
            loadingIndicator.setVisible(false);
        }
        
        updateContactList();
        
        if (!GeminiService.isApiKeySet()) {
            Platform.runLater(() -> {
                showAlert("âš ï¸ API í‚¤ ì„¤ì • í•„ìš”", 
                    "Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n" +
                    "GeminiService.java íŒŒì¼ì„ ì—´ì–´ì„œ\n" +
                    "API_KEY ë³€ìˆ˜ì— ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\n" +
                    "í‚¤ ë°œê¸‰: https://makersuite.google.com/app/apikey",
                    Alert.AlertType.WARNING);
            });
        }
        
        loadHistory();
        loadStats();
        
        System.out.println("âœ… UI ì»¨íŠ¸ë¡¤ëŸ¬ ì´ˆê¸°í™” ì™„ë£Œ");
    }
    
    private void updateContactList() {
    if (contactComboBox == null) return;
    
    // ğŸ”§ ìˆ˜ì •: ContactManagerë„ ì¶”ê°€!
    Set<String> contacts = new HashSet<>();
    contacts.addAll(dataManager.getAllContactNames());
    contacts.addAll(contactManager.getAllContactNames()); // ğŸ†• ì´ ì¤„ ì¶”ê°€!
    
    List<String> sortedContacts = new ArrayList<>(contacts);
    sortedContacts.remove("ì•Œ ìˆ˜ ì—†ìŒ");
    Collections.sort(sortedContacts);
    
    contactComboBox.setItems(FXCollections.observableArrayList(sortedContacts));
    
    if (!sortedContacts.isEmpty() && contactComboBox.getSelectionModel().isEmpty()) {
        List<Message> recent = dataManager.getRecentMessages(1);
        if (!recent.isEmpty()) {
            contactComboBox.setValue(recent.get(0).getContactName());
        }
    }
    
    if (contactCountLabel != null) {
        contactCountLabel.setText(String.format("ì´ %dëª…", sortedContacts.size()));
    }
}
    
    @FXML
    private void handleAddContact() {
        // ğŸ†• MBTI í¬í•¨ ë‹¤ì´ì–¼ë¡œê·¸
        Dialog<Contact> dialog = new Dialog<>();
        dialog.setTitle("ìƒˆ ì—°ë½ì²˜ ì¶”ê°€");
        dialog.setHeaderText("ğŸ‘¤ ìƒˆë¡œìš´ ëŒ€í™” ìƒëŒ€ë¥¼ ì¶”ê°€í•˜ì„¸ìš”");
        
        ButtonType addButtonType = new ButtonType("ì¶”ê°€", ButtonBar.ButtonData.OK_DONE);
        dialog.getDialogPane().getButtonTypes().addAll(addButtonType, ButtonType.CANCEL);
        
        GridPane grid = new GridPane();
        grid.setHgap(10);
        grid.setVgap(10);
        grid.setPadding(new Insets(20, 150, 10, 10));
        
        TextField nameField = new TextField();
        nameField.setPromptText("ì´ë¦„ ë˜ëŠ” ë³„ëª…");
        
        ComboBox<MBTI> mbtiComboBox = new ComboBox<>();
        mbtiComboBox.setItems(FXCollections.observableArrayList(MBTI.values()));
        mbtiComboBox.setValue(MBTI.UNKNOWN);
        mbtiComboBox.setPromptText("MBTI ì„ íƒ (ì„ íƒì‚¬í•­)");
        
        TextArea notesArea = new TextArea();
        notesArea.setPromptText("ë©”ëª¨ (ì„±í–¥, íŠ¹ì§• ë“±)");
        notesArea.setPrefRowCount(3);
        
        grid.add(new Label("ì´ë¦„:"), 0, 0);
        grid.add(nameField, 1, 0);
        grid.add(new Label("MBTI:"), 0, 1);
        grid.add(mbtiComboBox, 1, 1);
        grid.add(new Label("ë©”ëª¨:"), 0, 2);
        grid.add(notesArea, 1, 2);
        
        dialog.getDialogPane().setContent(grid);
        
        Platform.runLater(() -> nameField.requestFocus());
        
        dialog.setResultConverter(dialogButton -> {
            if (dialogButton == addButtonType) {
                String name = nameField.getText().trim();
                if (!name.isEmpty() && !name.equals("ì•Œ ìˆ˜ ì—†ìŒ")) {
                    MBTI mbti = mbtiComboBox.getValue();
                    String notes = notesArea.getText().trim();
                    return new Contact(name, mbti, notes);
                }
            }
            return null;
        });
        
        Optional<Contact> result = dialog.showAndWait();
        result.ifPresent(contact -> {
            contactManager.saveContact(contact);
            if (!contactComboBox.getItems().contains(contact.getName())) {
                contactComboBox.getItems().add(contact.getName());
                Collections.sort(contactComboBox.getItems());
            }
            contactComboBox.setValue(contact.getName());
            updateContactList();
            showAlert("ì¶”ê°€ ì™„ë£Œ", 
                "'" + contact.getDisplayInfo() + "'ë‹˜ì´ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.", 
                Alert.AlertType.INFORMATION);
        });
    }
    
    @FXML
    private void handleAnalyze() {
        String text = inputTextArea.getText().trim();
        
        if (text.isEmpty()) {
            showAlert("ì…ë ¥ ì˜¤ë¥˜", "ë¶„ì„í•  ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", Alert.AlertType.WARNING);
            return;
        }
        
        if (text.length() > 2000) {
            showAlert("ì…ë ¥ ì˜¤ë¥˜", 
                "í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤. (ìµœëŒ€ 2000ì)\ní˜„ì¬: " + text.length() + "ì",
                Alert.AlertType.WARNING);
            return;
        }
        
        String contactName = contactComboBox.getValue();
        if (contactName == null || contactName.trim().isEmpty()) {
            showAlert("ìƒëŒ€ë°© ì„ íƒ", 
                "ëŒ€í™” ìƒëŒ€ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.", 
                Alert.AlertType.WARNING);
            contactComboBox.requestFocus();
            return;
        }
        contactName = contactName.trim();
        
        if (!GeminiService.isApiKeySet()) {
            showAlert("API í‚¤ ì˜¤ë¥˜", 
                "Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n" +
                "GeminiService.java íŒŒì¼ì—ì„œ API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.",
                Alert.AlertType.ERROR);
            return;
        }
        
        // ğŸ†• ì—°ë½ì²˜ì—ì„œ MBTI ê°€ì ¸ì˜¤ê¸°
        Contact contact = contactManager.getContact(contactName);
        if (contact == null) {
            contact = new Contact(contactName);
            contactManager.saveContact(contact);
        }
        
        final String finalContactName = contactName;
        final MBTI mbti = contact.getMbti();
        
        setUIEnabled(false);
        if (loadingIndicator != null) {
            loadingIndicator.setVisible(true);
        }
        
        new Thread(() -> {
            try {
                System.out.println("ğŸ” ê°ì • ë¶„ì„ ì‹œì‘... (ìƒëŒ€: " + finalContactName + 
                    (mbti != MBTI.UNKNOWN ? ", MBTI: " + mbti.getCode() : "") + ")");
                
                // ğŸ†• MBTI ê¸°ë°˜ ë¶„ì„
                Message message = geminiService.analyzeEmotion(text, mbti);
                message.setContactName(finalContactName);
                
                Platform.runLater(() -> {
                    displayResult(message);
                    dataManager.saveMessage(message);
                    updateContactList();
                    loadHistory();
                    loadStats();
                    setUIEnabled(true);
                    if (loadingIndicator != null) {
                        loadingIndicator.setVisible(false);
                    }
                });
                
            } catch (Exception e) {
                Platform.runLater(() -> {
                    showAlert("ë¶„ì„ ì˜¤ë¥˜", 
                        "ê°ì • ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n" + e.getMessage(),
                        Alert.AlertType.ERROR);
                    setUIEnabled(true);
                    if (loadingIndicator != null) {
                        loadingIndicator.setVisible(false);
                    }
                });
            }
        }).start();
    }
    
    private void displayResult(Message message) {
        if (message == null) return;
        
        Emotion emotion = message.getEmotion();
        
        if (emotionLabel != null) {
            emotionLabel.setText(emotion.getEmoji() + " " + emotion.getKorean());
            emotionLabel.setStyle(String.format(
                "-fx-background-color: %s; " +
                "-fx-text-fill: white; " +
                "-fx-padding: 10; " +
                "-fx-background-radius: 10; " +
                "-fx-font-size: 18px; " +
                "-fx-font-weight: bold;",
                emotion.getColorCode()));
        }
        
        if (intensityLabel != null) {
            intensityLabel.setText(String.format(
                "ê°ì • ê°•ë„: %d%% (%s)", 
                message.getIntensityPercent(),
                message.getIntensityLevel()));
            intensityLabel.setStyle("-fx-font-size: 14px; -fx-padding: 5;");
        }
        
        if (responseTextArea != null) {
            responseTextArea.setText(message.getRecommendedResponse());
            responseTextArea.setStyle(String.format(
                "-fx-border-color: %s; " +
                "-fx-border-width: 2; " +
                "-fx-border-radius: 5; " +
                "-fx-padding: 10;",
                emotion.getColorCode()));
        }
        
        if (resultBox != null) {
            resultBox.setVisible(true);
        }
    }
    
    private void loadHistory() {
        if (historyBox == null) return;
        
        historyBox.getChildren().clear();
        
        List<Message> messages = dataManager.getRecentMessages(20);
        
        if (messages.isEmpty()) {
            Label emptyLabel = new Label("ğŸ“­ ì•„ì§ ë¶„ì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.\n\n" +
                "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  'ê°ì • ë¶„ì„í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!");
            emptyLabel.setStyle(
                "-fx-text-fill: gray; " +
                "-fx-font-size: 14px; " +
                "-fx-padding: 20; " +
                "-fx-text-alignment: center;");
            emptyLabel.setWrapText(true);
            historyBox.getChildren().add(emptyLabel);
            return;
        }
        
        for (Message msg : messages) {
            historyBox.getChildren().add(createMessageCard(msg));
        }
    }
    
    private VBox createMessageCard(Message message) {
        VBox card = new VBox(8);
        card.setPadding(new Insets(12));
        card.setStyle(String.format(
            "-fx-background-color: %s; " +
            "-fx-background-radius: 10; " +
            "-fx-border-color: %s; " +
            "-fx-border-width: 2; " +
            "-fx-border-radius: 10; " +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.1), 5, 0, 0, 2);",
            hexToRgba(message.getEmotion().getColorCode(), 0.08),
            message.getEmotion().getColorCode()));
        
        HBox header = new HBox(10);
        header.setAlignment(Pos.CENTER_LEFT);
        
        // ğŸ†• MBTI ì •ë³´ ì¶”ê°€
        Contact contact = contactManager.getContact(message.getContactName());
        String displayName = message.getContactName();
        if (contact != null && contact.hasMbti()) {
            displayName += " (" + contact.getMbti().getCode() + ")";
        }
        
        Label contactLabel = new Label("ğŸ‘¤ " + displayName);
        contactLabel.setStyle("-fx-font-size: 12px; -fx-text-fill: #333; -fx-font-weight: bold;");
        
        Label timeLabel = new Label("ğŸ• " + message.getFormattedTimestamp());
        timeLabel.setStyle("-fx-font-size: 11px; -fx-text-fill: #666;");
        
        Label emotionTag = new Label(message.getEmotion().getEmoji() + " " + 
            message.getEmotion().getKorean() + " " + 
            message.getIntensityPercent() + "%");
        emotionTag.setStyle(String.format(
            "-fx-background-color: %s; " +
            "-fx-text-fill: white; " +
            "-fx-padding: 3 10 3 10; " +
            "-fx-background-radius: 12; " +
            "-fx-font-size: 11px; " +
            "-fx-font-weight: bold;",
            message.getEmotion().getColorCode()));
        
            javafx.scene.layout.Region spacer = new javafx.scene.layout.Region();
            HBox.setHgrow(spacer, Priority.ALWAYS);
        
        header.getChildren().addAll(contactLabel, timeLabel, spacer, emotionTag);
        
        Label contentLabel = new Label("ğŸ’¬ " + message.getContent());
        contentLabel.setWrapText(true);
        contentLabel.setStyle(
            "-fx-font-size: 13px; " +
            "-fx-text-fill: #333; " +
            "-fx-padding: 5 0 5 0;");
        
        Separator separator = new Separator();
        
        Label responseLabel = new Label("ğŸ’¡ " + message.getRecommendedResponse());
        responseLabel.setWrapText(true);
        responseLabel.setStyle(
            "-fx-font-size: 12px; " +
            "-fx-text-fill: #555; " +
            "-fx-padding: 8; " +
            "-fx-background-color: rgba(255,255,255,0.5); " +
            "-fx-background-radius: 5;");
        
        card.getChildren().addAll(header, contentLabel, separator, responseLabel);
        
        return card;
    }
    
    private void loadStats() {
        if (statsBox == null) return;
        
        statsBox.getChildren().clear();
        
        int totalCount = dataManager.getTotalMessageCount();
        
        if (totalCount == 0) {
            Label emptyLabel = new Label("ğŸ“Š ì•„ì§ í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            emptyLabel.setStyle(
                "-fx-text-fill: gray; " +
                "-fx-font-size: 14px; " +
                "-fx-padding: 20;");
            statsBox.getChildren().add(emptyLabel);
            return;
        }
        
        VBox overallStats = createOverallStatsBox();
        statsBox.getChildren().add(overallStats);
        
        List<Message> allMessages = dataManager.getAllMessages();
        Map<String, List<Message>> messagesByContact = allMessages.stream()
            .collect(Collectors.groupingBy(Message::getContactName));
        
        List<String> sortedContacts = new ArrayList<>(messagesByContact.keySet());
        sortedContacts.remove("ì•Œ ìˆ˜ ì—†ìŒ");
        Collections.sort(sortedContacts);
        if (messagesByContact.containsKey("ì•Œ ìˆ˜ ì—†ìŒ")) {
            sortedContacts.add("ì•Œ ìˆ˜ ì—†ìŒ");
        }
        
        for (String contactName : sortedContacts) {
            List<Message> contactMessages = messagesByContact.get(contactName);
            VBox contactStatsBox = createContactStatsBox(contactName, contactMessages);
            statsBox.getChildren().add(contactStatsBox);
        }
    }
    
    private VBox createContactStatsBox(String contactName, List<Message> messages) {
        VBox box = new VBox(15);
        box.setPadding(new Insets(20));
        box.setStyle(
            "-fx-background-color: white; " +
            "-fx-background-radius: 10; " +
            "-fx-border-color: #e0e0e0; " +
            "-fx-border-width: 2; " +
            "-fx-border-radius: 10; " +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.08), 8, 0, 0, 2);");
        
        // ğŸ†• MBTI ì •ë³´ ì¶”ê°€
        Contact contact = contactManager.getContact(contactName);
        String displayName = contactName;
        if (contact != null && contact.hasMbti()) {
            displayName += " (" + contact.getMbti().getCode() + " " + contact.getMbti().getNickname() + ")";
        }
        
        Label titleLabel = new Label("ğŸ‘¤ " + displayName + "ë‹˜ê³¼ì˜ ëŒ€í™”");
        titleLabel.setStyle(
            "-fx-font-size: 16px; " +
            "-fx-font-weight: bold; " +
            "-fx-text-fill: #667eea;");
        
        int count = messages.size();
        double avgIntensity = messages.stream()
            .mapToDouble(Message::getIntensity)
            .average()
            .orElse(0.0);
        
        Map<Emotion, Long> emotionCount = messages.stream()
            .collect(Collectors.groupingBy(Message::getEmotion, Collectors.counting()));
        
        Emotion mostFrequent = emotionCount.entrySet().stream()
            .max(Map.Entry.comparingByValue())
            .map(Map.Entry::getKey)
            .orElse(Emotion.NEUTRAL);
        
        Label countLabel = new Label("ğŸ“ ëŒ€í™” íšŸìˆ˜: " + count + "íšŒ");
        countLabel.setStyle("-fx-font-size: 13px;");
        
        Label avgLabel = new Label(String.format("ğŸ“ˆ í‰ê·  ê°ì • ê°•ë„: %.0f%%", avgIntensity * 100));
        avgLabel.setStyle("-fx-font-size: 13px;");
        
        Label mostLabel = new Label("â­ ê°€ì¥ ë§ì€ ê°ì •: " + mostFrequent.getEmoji() + " " + mostFrequent.getKorean());
        mostLabel.setStyle("-fx-font-size: 13px;");
        
        HBox emotionBars = createMiniEmotionBars(emotionCount, count);
        
        box.getChildren().addAll(titleLabel, new Separator(), countLabel, avgLabel, mostLabel, emotionBars);
        
        return box;
    }
    
    private HBox createMiniEmotionBars(Map<Emotion, Long> emotionCount, int total) {
        HBox box = new HBox(5);
        box.setAlignment(Pos.CENTER_LEFT);
        
        for (Emotion emotion : Emotion.values()) {
            long count = emotionCount.getOrDefault(emotion, 0L);
            if (count > 0) {
                double percentage = (count / (double) total) * 100;
                
                VBox bar = new VBox(3);
                bar.setAlignment(Pos.BOTTOM_CENTER);
                bar.setMinWidth(40);
                
                Label emojiLabel = new Label(emotion.getEmoji());
                emojiLabel.setStyle("-fx-font-size: 14px;");
                
                javafx.scene.layout.Region colorBar = new javafx.scene.layout.Region();
                colorBar.setPrefWidth(30);
                colorBar.setPrefHeight(percentage * 1.5);
                colorBar.setStyle(String.format(
                    "-fx-background-color: %s; " +
                    "-fx-background-radius: 5 5 0 0;",
                    emotion.getColorCode()));
                
                Label percentLabel = new Label(String.format("%.0f%%", percentage));
                percentLabel.setStyle("-fx-font-size: 10px; -fx-text-fill: #666;");
                
                bar.getChildren().addAll(emojiLabel, colorBar, percentLabel);
                box.getChildren().add(bar);
            }
        }
        
        return box;
    }
    
    private VBox createOverallStatsBox() {
        VBox box = new VBox(10);
        box.setPadding(new Insets(20));
        box.setStyle(
            "-fx-background-color: linear-gradient(to right, #667eea, #764ba2); " +
            "-fx-background-radius: 10; " +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.15), 10, 0, 0, 2);");
        
        Label titleLabel = new Label("ğŸ“Š ì „ì²´ ê°ì • ë¶„ì„ í†µê³„");
        titleLabel.setStyle(
            "-fx-font-size: 18px; " +
            "-fx-font-weight: bold; " +
            "-fx-text-fill: white;");
        
        int totalCount = dataManager.getTotalMessageCount();
        int todayCount = dataManager.getTodayMessageCount();
        double avgIntensity = dataManager.getAverageIntensity();
        Emotion mostFrequent = dataManager.getMostFrequentEmotion();
        
        Label totalLabel = new Label("ğŸ“ ì´ ë¶„ì„ íšŸìˆ˜: " + totalCount + "íšŒ");
        totalLabel.setStyle("-fx-font-size: 14px; -fx-text-fill: white;");
        
        Label todayLabel = new Label("ğŸ“… ì˜¤ëŠ˜ì˜ ë¶„ì„: " + todayCount + "íšŒ");
        todayLabel.setStyle("-fx-font-size: 14px; -fx-text-fill: white;");
        
        Label avgLabel = new Label(String.format("ğŸ“ˆ í‰ê·  ê°ì • ê°•ë„: %.0f%%", avgIntensity * 100));
        avgLabel.setStyle("-fx-font-size: 14px; -fx-text-fill: white;");
        
        Label mostLabel = new Label("â­ ê°€ì¥ ë§ì€ ê°ì •: " + mostFrequent.getEmoji() + " " + mostFrequent.getKorean());
        mostLabel.setStyle("-fx-font-size: 14px; -fx-text-fill: white;");
        
        box.getChildren().addAll(titleLabel, totalLabel, todayLabel, avgLabel, mostLabel);
        
        return box;
    }
    
    @FXML
    private void handleClearData() {
        Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
        alert.setTitle("ë°ì´í„° ì‚­ì œ í™•ì¸");
        alert.setHeaderText("ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        alert.setContentText(
            "ì €ì¥ëœ ëª¨ë“  ë©”ì‹œì§€ì™€ í†µê³„ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\n" +
            "ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
        
        alert.showAndWait().ifPresent(response -> {
            if (response == ButtonType.OK) {
                dataManager.clearAllData();
                updateContactList();
                loadHistory();
                loadStats();
                if (resultBox != null) {
                    resultBox.setVisible(false);
                }
                if (inputTextArea != null) {
                    inputTextArea.clear();
                }
                showAlert("ì‚­ì œ ì™„ë£Œ", 
                    "ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", 
                    Alert.AlertType.INFORMATION);
            }
        });
    }
    
    private void setUIEnabled(boolean enabled) {
        if (inputTextArea != null) {
            inputTextArea.setDisable(!enabled);
        }
        if (analyzeButton != null) {
            analyzeButton.setDisable(!enabled);
        }
        if (contactComboBox != null) {
            contactComboBox.setDisable(!enabled);
        }
        if (addContactButton != null) {
            addContactButton.setDisable(!enabled);
        }
    }
    
    private void showAlert(String title, String content, Alert.AlertType type) {
        Alert alert = new Alert(type);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(content);
        alert.showAndWait();
    }
    
    private void showAlert(String title, String content) {
        showAlert(title, content, Alert.AlertType.INFORMATION);
    }
    
    @FXML
    private void handleImportKakaoCSV() {
        javafx.stage.FileChooser fileChooser = new javafx.stage.FileChooser();
        fileChooser.setTitle("ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” CSV íŒŒì¼ ì„ íƒ");
        fileChooser.getExtensionFilters().add(
            new javafx.stage.FileChooser.ExtensionFilter("CSV íŒŒì¼", "*.csv"));
        
        java.io.File file = fileChooser.showOpenDialog(analyzeButton.getScene().getWindow());
        
        if (file == null) {
            return;
        }
        
        setUIEnabled(false);
        if (loadingIndicator != null) {
            loadingIndicator.setVisible(true);
        }
        
        new Thread(() -> {
            try {
                System.out.println("ğŸ“ CSV íŒŒì¼ íŒŒì‹± ì¤‘: " + file.getName());
                
                KakaoParser.ParseResult result = KakaoParser.parseCSV(file);
                
                if (result.getTotalMessageCount() == 0) {
                    Platform.runLater(() -> {
                        showAlert("íŒŒì‹± ì‹¤íŒ¨", 
                            "CSV íŒŒì¼ì—ì„œ ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 
                            Alert.AlertType.WARNING);
                        setUIEnabled(true);
                        if (loadingIndicator != null) {
                            loadingIndicator.setVisible(false);
                        }
                    });
                    return;
                }
                
                // ìƒëŒ€ë°© í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
                Platform.runLater(() -> {
                    String otherUser = result.getOtherUser();
                    
                    Alert confirmAlert = new Alert(Alert.AlertType.CONFIRMATION);
                    confirmAlert.setTitle("ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ê°€ì ¸ì˜¤ê¸°");
                    confirmAlert.setHeaderText("ğŸ“Š íŒŒì‹± ê²°ê³¼");
                    confirmAlert.setContentText(
                        "ì´ ë©”ì‹œì§€: " + result.getTotalMessageCount() + "ê°œ\n" +
                        "ì£¼ ì‚¬ìš©ì (ë‚˜): " + result.getMainUser() + "\n" +
                        "ìƒëŒ€ë°©: " + otherUser + "\n\n" +
                        "ìƒëŒ€ë°© ë©”ì‹œì§€ë¥¼ ë¶„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                    
                    Optional<ButtonType> confirmResult = confirmAlert.showAndWait();
                    if (confirmResult.isPresent() && confirmResult.get() == ButtonType.OK) {
                        processKakaoMessages(result, otherUser);
                    } else {
                        setUIEnabled(true);
                        if (loadingIndicator != null) {
                            loadingIndicator.setVisible(false);
                        }
                    }
                });
                
            } catch (Exception e) {
                Platform.runLater(() -> {
                    showAlert("ì˜¤ë¥˜", 
                        "CSV íŒŒì¼ íŒŒì‹± ì¤‘ ì˜¤ë¥˜:\n\n" + e.getMessage(),
                        Alert.AlertType.ERROR);
                    e.printStackTrace();
                    setUIEnabled(true);
                    if (loadingIndicator != null) {
                        loadingIndicator.setVisible(false);
                    }
                });
            }
        }).start();
    }
    
    private void processKakaoMessages(KakaoParser.ParseResult result, String contactName) {
        new Thread(() -> {
            try {
                // ì „ì²´ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                List<KakaoParser.KakaoMessage> allMessages = result.getMessages();
                
                System.out.println("ğŸ“¨ ì „ì²´ ë©”ì‹œì§€: " + allMessages.size() + "ê°œ");
                
                // ì—°ë½ì²˜ í™•ì¸/ìƒì„±
                Contact contact = contactManager.getContact(contactName);
                if (contact == null) {
                    contact = new Contact(contactName);
                    contactManager.saveContact(contact);
                }
                final MBTI mbti = contact.getMbti();
                
                // ğŸ†• ëŒ€í™” ë§¥ë½ ìƒì„± (ìµœê·¼ 20ê°œ ë˜ëŠ” ì „ì²´)
                int contextCount = Math.min(20, allMessages.size());
                String conversationContext = KakaoParser.toConversationContext(allMessages, contextCount);
                
                // ğŸ†• ë§ˆì§€ë§‰ ìƒëŒ€ë°© ë©”ì‹œì§€ ì°¾ê¸°
                KakaoParser.KakaoMessage lastMessage = null;
                for (int i = allMessages.size() - 1; i >= 0; i--) {
                    KakaoParser.KakaoMessage msg = allMessages.get(i);
                    if (msg.getUser().equals(result.getOtherUser())) {
                        lastMessage = msg;
                        break;
                    }
                }
                
                if (lastMessage == null) {
                    Platform.runLater(() -> {
                        showAlert("ë¶„ì„ ì‹¤íŒ¨", 
                            "ìƒëŒ€ë°©ì˜ ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 
                            Alert.AlertType.WARNING);
                        setUIEnabled(true);
                        if (loadingIndicator != null) {
                            loadingIndicator.setVisible(false);
                        }
                    });
                    return;
                }
                
                final KakaoParser.KakaoMessage finalLastMessage = lastMessage;
                
                System.out.println("ğŸ¯ ë§ˆì§€ë§‰ ìƒëŒ€ë°© ë©”ì‹œì§€: " + lastMessage.getMessage());
                System.out.println("ğŸ“š ëŒ€í™” ë§¥ë½ (" + contextCount + "ê°œ ë©”ì‹œì§€):");
                System.out.println(conversationContext);
                
                // ğŸ†• ë§¥ë½ ê¸°ë°˜ ë¶„ì„ (ë§ˆì§€ë§‰ ë©”ì‹œì§€ë§Œ)
                Message analyzedMessage = geminiService.analyzeEmotionWithContext(
                    finalLastMessage.getMessage(), 
                    conversationContext, 
                    mbti
                );
                analyzedMessage.setContactName(contactName);
                analyzedMessage.setTimestamp(finalLastMessage.getDateTime());
                
                dataManager.saveMessage(analyzedMessage);
                
                Platform.runLater(() -> {
                    updateContactList();
                    loadHistory();
                    loadStats();
                    
                    // ê²°ê³¼ í‘œì‹œ
                    displayResult(analyzedMessage);
                    
                    setUIEnabled(true);
                    if (loadingIndicator != null) {
                        loadingIndicator.setVisible(false);
                    }
                    
                    showAlert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!", 
                        String.format("ğŸ“Š ì „ì²´ ëŒ€í™”: %dê°œ ë©”ì‹œì§€\n" +
                                     "ğŸ¯ ë§ˆì§€ë§‰ ë©”ì‹œì§€ ë¶„ì„ ì™„ë£Œ!\n\n" +
                                     "ê°ì •: %s %s (%d%%)\n" +
                                     "ì¶”ì²œ ë‹µë³€ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.",
                            allMessages.size(),
                            analyzedMessage.getEmotion().getEmoji(),
                            analyzedMessage.getEmotion().getKorean(),
                            analyzedMessage.getIntensityPercent()),
                        Alert.AlertType.INFORMATION);
                });
                
            } catch (Exception e) {
                Platform.runLater(() -> {
                    showAlert("ì˜¤ë¥˜", 
                        "ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:\n\n" + e.getMessage(),
                        Alert.AlertType.ERROR);
                    e.printStackTrace();
                    setUIEnabled(true);
                    if (loadingIndicator != null) {
                        loadingIndicator.setVisible(false);
                    }
                });
            }
        }).start();
    }

    private String hexToRgba(String hex, double alpha) {
        try {
            Color color = Color.web(hex);
            return String.format("rgba(%d, %d, %d, %.2f)",
                (int)(color.getRed() * 255),
                (int)(color.getGreen() * 255),
                (int)(color.getBlue() * 255),
                alpha);
        } catch (Exception e) {
            return "rgba(128, 128, 128, " + alpha + ")";
        }
    }
}
