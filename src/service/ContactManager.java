package service;

import model.Contact;
import model.MBTI;

import java.io.*;
import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;
import java.util.*;

public class ContactManager {
    private static final String CONTACTS_FILE = "data/contacts.txt";
    private Map<String, Contact> contacts;
    
    public ContactManager() {
        this.contacts = new HashMap<>();
        loadContacts();
        System.out.println("ğŸ“‡ ì—°ë½ì²˜ ë§¤ë‹ˆì € ì´ˆê¸°í™” ì™„ë£Œ (ì—°ë½ì²˜ " + contacts.size() + "ê°œ)");
    }
    
    public void saveContact(Contact contact) {
        if (contact == null || contact.getName() == null || contact.getName().trim().isEmpty()) {
            return;
        }
        
        contacts.put(contact.getName(), contact);
        saveToFile();
        System.out.println("ğŸ’¾ ì—°ë½ì²˜ ì €ì¥: " + contact.getDisplayInfo());
    }
    
    public Contact getContact(String name) {
        return contacts.get(name);
    }
    
    public boolean hasContact(String name) {
        return contacts.containsKey(name);
    }
    
    public List<Contact> getAllContacts() {
        List<Contact> list = new ArrayList<>(contacts.values());
        list.sort(Comparator.comparing(Contact::getName));
        return list;
    }
    
    public Set<String> getAllContactNames() {
        return new TreeSet<>(contacts.keySet());
    }
    
    public void setMbti(String name, MBTI mbti) {
        Contact contact = contacts.get(name);
        if (contact != null) {
            contact.setMbti(mbti);
            saveToFile();
            System.out.println("âœ… MBTI ì„¤ì •: " + name + " â†’ " + mbti.getCode());
        }
    }
    
    public void setNotes(String name, String notes) {
        Contact contact = contacts.get(name);
        if (contact != null) {
            contact.setNotes(notes);
            saveToFile();
        }
    }
    
    public void setAutoGeneratedProfile(String name, String profile) {
        Contact contact = contacts.get(name);
        if (contact != null) {
            contact.setAutoGeneratedProfile(profile);
            saveToFile();
            System.out.println("âœ… ìë™ í”„ë¡œí•„ ì €ì¥: " + name);
        }
    }

    public void deleteContact(String name) {
        if (contacts.remove(name) != null) {
            saveToFile();
            System.out.println("ğŸ—‘ï¸ ì—°ë½ì²˜ ì‚­ì œ: " + name);
        }
    }
    
    public void clearAll() {
        contacts.clear();
        saveToFile();
        System.out.println("ğŸ—‘ï¸ ëª¨ë“  ì—°ë½ì²˜ ì‚­ì œ");
    }
    
    private void saveToFile() {
        try {
            File dataDir = new File("data");
            if (!dataDir.exists()) {
                dataDir.mkdirs();
            }
            
            try (PrintWriter writer = new PrintWriter(
                new OutputStreamWriter(new FileOutputStream(CONTACTS_FILE), StandardCharsets.UTF_8))) {
                
                for (Contact contact : contacts.values()) {
                    writer.println(contactToString(contact));
                }
            }
        } catch (IOException e) {
            System.err.println("âŒ ì—°ë½ì²˜ ì €ì¥ ì‹¤íŒ¨: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    private void loadContacts() {
        File file = new File(CONTACTS_FILE);
        if (!file.exists()) {
            System.out.println("ğŸ“„ ì—°ë½ì²˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤.");
            return;
        }
        
        try (BufferedReader reader = new BufferedReader(
            new InputStreamReader(new FileInputStream(file), StandardCharsets.UTF_8))) {
            
            String line;
            int loadCount = 0;
            
            while ((line = reader.readLine()) != null) {
                Contact contact = stringToContact(line);
                if (contact != null) {
                    contacts.put(contact.getName(), contact);
                    loadCount++;
                }
            }
            
            System.out.println("âœ… " + loadCount + "ê°œì˜ ì—°ë½ì²˜ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
            
        } catch (IOException e) {
            System.err.println("âŒ ì—°ë½ì²˜ ë¡œë“œ ì‹¤íŒ¨: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    private String contactToString(Contact contact) {
        String name = contact.getName().replace("|", "ï½œ");
        String mbti = contact.getMbti().name();
        String notes = contact.getNotes().replace("|", "ï½œ").replace("\n", "\\n");
        String profile = (contact.getAutoGeneratedProfile() != null ? 
            contact.getAutoGeneratedProfile() : "").replace("|", "ï½œ").replace("\n", "\\n"); // ğŸ†•
        String createdAt = contact.getCreatedAt().toString();
        String updatedAt = contact.getUpdatedAt().toString();
        
        return String.format("%s|%s|%s|%s|%s|%s",
            name, mbti, notes, profile, createdAt, updatedAt); // ğŸ†• profile ì¶”ê°€
    }
    
    private Contact stringToContact(String str) {
        try {
            String[] parts = str.split("\\|");
            if (parts.length < 3) {
                return null;
            }
            
            String name = parts[0].replace("ï½œ", "|");
            MBTI mbti = MBTI.valueOf(parts[1]);
            String notes = parts[2].replace("ï½œ", "|").replace("\\n", "\n");
            
            Contact contact = new Contact(name, mbti, notes);
            
            // ğŸ†• ìë™ í”„ë¡œí•„ ë¡œë“œ
            if (parts.length >= 4 && !parts[3].isEmpty()) {
                String profile = parts[3].replace("ï½œ", "|").replace("\\n", "\n");
                contact.setAutoGeneratedProfile(profile);
            }
            
            // ğŸ”§ ì¸ë±ìŠ¤ ë³€ê²½ (profileì´ ì¶”ê°€ë˜ì–´ì„œ +1)
            if (parts.length >= 6) {
                contact.setCreatedAt(LocalDateTime.parse(parts[4]));
                contact.setUpdatedAt(LocalDateTime.parse(parts[5]));
            }
            
            return contact;
            
        } catch (Exception e) {
            System.err.println("âš ï¸ ì—°ë½ì²˜ íŒŒì‹± ì‹¤íŒ¨: " + e.getMessage());
            return null;
        }
    }
}
